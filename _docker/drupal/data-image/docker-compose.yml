version: '2'
services:
  bootstrap_env:
    image: "${DRUPAL_IMAGE}"
    entrypoint: ["/bin/bash", "-c", "ansible-playbook bootstrap-env.yml"]
    user: root
    working_dir: "/ansible"
    environment:
    - DEPLOYMENT_ID=1
    volumes:
    - ./env.yml:/credentials/ansible/env.yml
    - ./drupal-workspace:/drupal-workspace
    depends_on:
    - mysql

  bootstrap_drupal:
    image: "${DRUPAL_IMAGE}"
    command: ["/bin/bash", "-c", "ansible-playbook bootstrap-drupal.yml"]
    working_dir: "/ansible"
    environment:
    - DEPLOYMENT_ID=1
    volumes:
    - ./env.yml:/credentials/ansible/env.yml
    - ./drupal-workspace/drupal_1/drupal/credentials/rhd.settings.yml:/var/www/drupal/web/sites/default/rhd.settings.yml
    - ./drupal-workspace/drupal_1/drupal/credentials/rhd.settings.php:/var/www/drupal/web/sites/default/rhd.settings.php
    - ./drupal-workspace/drupal_1/drupal/credentials/phinx.yml:/var/www/drupal/phinx.yml
    - ./drupal-workspace/drupal_1/drupal/config/active:/var/www/drupal/web/config/active
    - ./drupal-workspace:/drupal-workspace
    depends_on:
    - mysql

  backup_drupal:
    build:
      context: ../
      dockerfile: Dockerfile.mp
    command: ["/bin/bash", "-c", "ansible-playbook backup-drupal.yml"]
    working_dir: "/ansible"
    environment:
      - DEPLOYMENT_ID=1
    volumes:
      - ./env.yml:/credentials/ansible/env.yml
      - ./drupal-workspace/drupal_1/drupal/credentials/rhd.settings.yml:/var/www/drupal/web/sites/default/rhd.settings.yml
      - ./drupal-workspace/drupal_1/drupal/credentials/rhd.settings.php:/var/www/drupal/web/sites/default/rhd.settings.php
      - ./drupal-workspace/drupal_1/drupal/config/active:/var/www/drupal/web/config/active
      - ./drupal-workspace/drupal_1/drupal/sites/default/files:/var/www/drupal/web/sites/default/files
      - ./drupal-workspace:/drupal-workspace
      - ./work:/tmp
    depends_on:
      - mysql

  mysql:
    image: mariadb:10.3.9-bionic
    environment:
    - MYSQL_ROOT_PASSWORD=password
    ports:
    - "3306:3306"
    expose:
    - 3306